#!/usr/bin/env python3
"""Capture an idea in a tmux popup and append it to post-ideas.md."""

import datetime
import os
import subprocess
import sys
import tempfile


IDEAS_DIR = "/Users/will/github/personal/posts"
IDEAS_FILE = os.path.join(IDEAS_DIR, "post-ideas.md")


def tmux_display(message: str) -> None:
    subprocess.run(["tmux", "display-message", message], check=False)


def tmux_session() -> str:
    try:
        result = subprocess.run(
            ["tmux", "display-message", "-p", "#S"],
            capture_output=True,
            text=True,
            check=True,
        )
        return result.stdout.strip() or "(unknown)"
    except subprocess.CalledProcessError:
        return "(unknown)"


def open_editor(path: str) -> int:
    editor = os.environ.get("EDITOR", "vim")
    return subprocess.run([editor, path], check=False).returncode


def read_idea(path: str) -> tuple[str, list[str]] | None:
    with open(path, encoding="utf-8") as fh:
        raw = fh.read()

    if not raw.strip():
        return None

    lines = raw.splitlines()
    while lines and not lines[0].strip():
        lines.pop(0)
    while lines and not lines[-1].strip():
        lines.pop()
    if not lines:
        return None

    idea_line = lines[0].strip()
    summary_lines = lines[1:]
    while summary_lines and not summary_lines[0].strip():
        summary_lines.pop(0)

    return idea_line, summary_lines


def append_entry(idea: str, summary: list[str]) -> None:
    timestamp = datetime.datetime.now().astimezone().isoformat()
    session = tmux_session()
    path = os.getcwd()
    os.makedirs(IDEAS_DIR, exist_ok=True)
    entry = [
        "---",
        f"Timestamp: {timestamp}",
        f"Session: {session}",
        f"Path: {path}",
        f"Idea: {idea}",
        "Summary:",
    ]
    if summary:
        entry.extend(summary)
    else:
        entry.append("(no summary)")
    entry.append("")

    with open(IDEAS_FILE, "a", encoding="utf-8") as fh:
        fh.write("\n".join(entry) + "\n")


def main() -> int:
    tmux_display("Idea capture: idea line first, blank line, then summary.")
    temp = tempfile.NamedTemporaryFile(mode="w+", suffix=".md", delete=False)
    temp_path = temp.name
    temp.close()
    try:
        open_editor(temp_path)
        parsed = read_idea(temp_path)
        if not parsed:
            tmux_display("Idea cancelled (no content saved).")
            return 1
        idea, summary = parsed
        append_entry(idea, summary)
        tmux_display(f"Idea saved ({idea[:40]}).")
        return 0
    finally:
        try:
            os.unlink(temp_path)
        except OSError:
            pass


if __name__ == "__main__":
    sys.exit(main())
